---
title: "Mcap_CD"
author: "Shayle Matsuda"
date: "12/5/2020"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mcap CD growth experiment: Buoyant Weight and qPCR

#Buoyant WEIGHT
```{r}
#rm(list=ls()) # removes all prior objects

library("car") #levenes test
library("ggplot2") #plotting
library("plotrix") #plotting
library("reshape") #data shaping
require("gridExtra") #Arrange Plots for output
require("plyr") #for ddply
require("dplyr")
require("utils")
library("reshape2") #data shaping
library(lubridate)

#load metadata
geno.frag<-read.csv("UROP_metadata_colony.csv")
  geno.frag$genotype<-as.factor(as.character(geno.frag$genotype))
  geno.frag$frag.id<-as.factor(as.character(geno.frag$frag.id))

#load shade levels
shade.levels<-read.csv("shade.levels.csv")
  shade.levels$frag.id<-as.factor(as.character(shade.levels$frag.id))
  shade.levels$treatment<-as.factor(as.character(shade.levels$treatment))
  shade.levels$light.level<-as.factor((shade.levels$light.level))
  shade.levels<-unique(shade.levels) #remove dups

  # geno_fragid<-geno.frag$frag.id               #Check for missing data
  # shade.levels_fragid<-shade.levels$frag.id
  #diffs<-as.data.frame(setdiff( geno_fragid, shade.levels_fragid))
  metadata<-merge(shade.levels,geno.frag, by.x="frag.id",no.dups=T)

#add in depth data
geno.depth<-read.csv("UROP_geno_Depth.csv")
  # meta_genoID<-metadata$genotype        ##### Check for missing data
  # depth_genoID<-geno.depth$genotype
  #diffs<-as.data.frame(setdiff(meta_genoID, depth_genoID)) # no depth data for 912, 916, 909, 911, 910, 922, 920
  metadata<-merge(metadata,geno.depth, by.x="genotype")

# add tank meta
tank<-read.csv("UROP_frag_tank.csv")

metadata<-merge(metadata,tank, by.x="frag.id")

```
BW: original code HP

```{r}
BW.data.T0 <-read.csv('Buoyant_weight/UROP_BW_T0_20171029.csv') 
BW.data.T1 <-read.csv('Buoyant_weight/UROP_BW_T1_20171129.csv') 
BW.data.T2 <-read.csv('Buoyant_weight/UROP_BW_T2_20180108.csv')
BW.data <- rbind(BW.data.T0, BW.data.T1, BW.data.T2) #combine

BW.data<-merge(BW.data, metadata, by.x= "frag.id") 

  BW_fragid<-BW.data$frag.id
  meta_fragid<-metadata$frag.id
  setdiff(BW_fragid, meta_fragid) #check what we lose, 142 144  73 283 217  cannot find genotype info in MO notes


BW.data$frag.id<-as.factor(as.character(BW.data$frag.id))
BW.data$temp.c<-as.numeric(BW.data$temp.c)
BW.data$time.point<-as.factor(as.character(BW.data$time.point))

BW <- BW.data$mass.g
Temp <- BW.data$temp.C 


#HP
# load data 
CalData<-read.csv('Buoyant_weight/Bouyant_weight_calibration_curve.csv', header=T, sep=",")
#Data with Standard weights in grams in deionized water, saltwater, and the temp that they were measured at

#plot relationship between temp and Standard in fresh and salt water
plot(CalData$Temp, CalData$StandardSalt, col = 'red', ylab = 'Salt Weight (g)', xlab = 'Temp C')
par(new=TRUE)
plot(CalData$Temp, CalData$StandardFresh, col = 'blue',xaxt="n",yaxt="n",xlab="",ylab="")
axis(4)
mtext("'Fresh Weight (g)'",side=4,line=3)
legend("topleft",col=c("red","blue"),lty=1,legend=c("Salt","Fresh"), bty = "n")

#linear regression between temp and Standard
#Salt water standard measures
StandardSaltModel <- lm(CalData$StandardSalt~CalData$Temp)
summary(StandardSaltModel)
summary(StandardSaltModel)$r.squared
StandardSaltModel$coef

#Fresh water standard measures
StandardFreshModel <- lm(CalData$StandardFresh~CalData$Temp)
summary(StandardFreshModel)
summary(StandardFreshModel)$r.squared
StandardFreshModel$coef

BW <- BW.data$mass.g
Temp <- BW.data$temp.c 

BWCalc_Mcap <- function(StandardAir= 39.092, Temp, BW, CoralDensity = 2.03){
  #Parameters---------------------------------------------------------------
  # StandardAir is the weight of the Standard in air (Default set at 39.092 grams weighed on balance)
  # Temp is the temperature of the water during the coral measurement
  # BW is the buoywant weight of the coral
  # CoralDensity <- 2.03 #g cm-3, set aragonite density for Montipora from literature 
  #Montipora Arag = 2.03 g cm-3 average from table 2 in Anthony 2003 Functional Ecology 17:246-259
  

 #Calculation------------------------------------------------------------
  #Step 1: correct the Standard weights for temperature
  # StandardFresh is the weight of the Standard in  fresh water at temp x
  # StandardSalt is the weight of the Standard in salt water at temp x
  
  # This is based on a calibration curve for Standards weighed in fresh and salt water at many temps
StandardFresh <- StandardFreshModel$coef[-1]*Temp + StandardFreshModel$coef[1] 
StandardSalt <- StandardSaltModel$coef[-1]*Temp + StandardSaltModel$coef[1] 
  
  # Step 2: Use weight in air and freshwater of the  Standard to calculate
  # the density of the Standard (Davies eq. 4)
FreshDensity <- 1 #Fresh water has a density of 1 g/cm3
StandardDensity <- FreshDensity/(1-(StandardFresh/StandardAir)) 
  
  # Step 3: Calculate the density of seawater using the density of the Standard
  # (Spencer Davies eq. 3)
SWDensity <- StandardDensity*(1-(StandardSalt/StandardAir))
  
  # Step 4: Calculate the dry weight of the coral (Davies eq. 1)
CoralWeight <- BW/(1-(SWDensity/CoralDensity))
  
  return(CoralWeight) #returns coral dry weights in g
}
   
BW.data$Dry.Weigh.g <- BWCalc_Mcap(BW=BW, Temp=Temp) #use function to calculate dry weight
hist(BW.data$Dry.Weigh.g) #not normal
 #BW.data$Dry.Weigh.g_log<-log10(BW.data$Dry.Weigh.g+1)
 #hist(BW.data$Dry.Weigh.g_log) #better
#boxplot(BW.data$Dry.Weigh.g_log) #examine data

# Entering the tidyverse!!!
BW.data <- tibble(BW.data)
BW.data <- BW.data %>%
  select(-mass.g, -temp.c, -notes, -date, -tratment, -treatment) 

BW.data <- BW.data %>%
  mutate(big.tank = factor(big.tank),
         tank = factor(tank))
```

# qPCR
```{r}
# Read in and tidy processed qPCR data
qpcr <- read_csv("qPCR/qpcr_processed.csv")

qpcr <- qpcr %>%
  select(frag.id, time, propD, dom = Dom, mix = Mix) %>%
  mutate(time.point = if_else(time == "Time1", "T0", "T2")) %>%
  select(-time)

# Join qPCR data with BW data and sample metadata
df <- full_join(BW.data, qpcr)

# Number of rows corresponding to each genotype at each time point
df %>%
  group_by(genotype, time.point) %>%
  dplyr::summarize(n = n()) %>%
  pivot_wider(names_from = time.point, values_from = n)

# Colony 867 has 8 frags associated with it--- change frags 47-50 to genotype 999
df <- df %>%
  mutate(genotype = as.character(genotype)) %>%
  mutate(genotype = if_else(frag.id %in% c("47", "48", "49", "50"), "999", genotype)) %>%
  mutate(genotype = factor(genotype))



df %>% filter(frag.id == 283)
BW.data.T0 %>% filter(frag.id == 283)



# Samples with qPCR data but NO BW data
missing_bw <- anti_join(qpcr, BW.data)

# Samples with BW data but NO qPCR data
missing_qpcr <- anti_join(BW.data, qpcr) %>%
   filter(time.point == "T0")

# Number of rows corresponding to each genotype at each time point
df %>%
  group_by(genotype, time.point) %>%
  dplyr::summarize(n = n()) %>%
  pivot_wider(names_from = time.point, values_from = n)


# Any genotypes with different symbionts?
df %>%
  group_by(genotype) %>%
  drop_na(dom) %>%
  dplyr::summarize(sym = paste0(unique(dom), collapse = ",")) %>%
  filter(nchar(sym) > 1)

# Look at data for one genotype
df %>%
  dplyr::filter(genotype == 867)  %>%
  arrange(frag.id, time.point) %>%
  print(n = nrow(.))
```


