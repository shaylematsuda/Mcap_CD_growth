---
title: "analysis.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(lme4)
library(emmeans)
library(multcomp)
library(broom.mixed)
library(tidyverse)
```

# Load in data
```{r}
df <- read_csv("all_data_cleaned.csv")

```

# Mortality
```{r}
df.mort <- df %>% drop_na(mortality) #remove df with no mortality score
df.mort$time.point<-as.factor(df.mort$time.point)  
df.mort$genotype<-as.factor(df.mort$genotype)  
df.mort$tank<-as.factor(df.mort$tank)  
df.mort$dom<-as.factor(df.mort$dom)  
df.mort$color<-as.factor(df.mort$color)  




  ggplot(df.mort, aes(x = days, y = mortality, color = dom, group = frag.id)) +  # look at mort/time
   facet_wrap(~light.level) + 
    geom_line()

df.mort %>%
  pivot_wider(id_cols = c(frag.id, time.point, genotype, light.level, dom, color),
              names_from = time.point,
              values_from = mortality) %>%
  filter(T2 < T1)

# boxplot C v D:facet by shade treatment #####

df.mort$light.level <- factor(df.mort$light.level,                                          # Reordering group factor levels
                         levels = c("Natural", "Low Shade", "Medium Shade", "High Shade"))

df.mort %>%
  group_by(dom, light.level, time.point) %>%
  summarize(mean = mean(mortality, na.rm = T)) %>%
  ggplot(aes(x = ))

ggplot(df.mort, aes(x = time.point, y = mortality, color = dom)) +
  facet_wrap(~light.level) + 
   theme_classic()+
    geom_boxplot()

ggplot(df.mort, aes(x = interaction(dom,time.point), y = mortality, color = dom)) +
  facet_wrap(~light.level) + 
   theme_classic()+
    geom_jitter()+
    scale_y_continuous(breaks=1:6)+
  


# models
# check for normality (not normal)
hist(df.mort$mortality) # pos skew
  qqnorm(df.mort$mortality, pch = 1, frame = FALSE)
  qqline(df.mort$mortality, col = "steelblue", lwd = 2)

df.mort$mort_log<- log10(df.mort$mortality)
hist(df.mort$mort_log) # pos skew
   qqnorm(df.mort$mort_log, pch = 1, frame = FALSE)
   qqline(df.mort$mort_log, col = "steelblue", lwd = 2)
   
df.mort$mort_cube<- df.mort$mortality^(1/3)
hist(df.mort$mort_cube) # pos skew
   qqnorm(df.mort$mort_cube, pch = 1, frame = FALSE)
   qqline(df.mort$mort_cube, col = "steelblue", lwd = 2)

df.mort$mort_inv<- 1/df.mort$mortality
hist(df.mort$mort_inv) # now just neg skew
   qqnorm(df.mort$mort_inv, pch = 1, frame = FALSE)
   qqline(df.mort$mort_inv, col = "steelblue", lwd = 2)

# lmer <- probably should not use due to normality violations
mod <- lmer(log(mortality) ~ time.point * dom * light.level + (1|genotype) + (1|tank), data = df.mort)
Anova(mod)

hist(residuals(mod)) #normal
shapiro.test(residuals(mod))  #p-value < 2.2e-16
qqPlot(residuals(mod)) #kinda look like crap

# glmer
  mod <- glmer(mortality ~ dom * light.level *time.point + (1|genotype) + (1|tank), family=poisson(), data = df.mort)
    Anova(mod)

  # by time only
  mod <- glmer(mortality ~ time.point + (1|genotype) +(1|tank) , family=poisson(), data = df.mort)
    Anova(mod)
    
  # by time * dom
  mod <- glmer(mortality ~ time.point * dom + (1|genotype) +(1|tank) , family=poisson(), data = df.mort)
    Anova(mod)
    
   # by time * dom * light.level <- model failed to converge
  mod <- glmer(mortality ~ time.point * dom *light.level + (1|genotype) +(1|tank) , family=poisson(), data = df.mort)
    Anova(mod)
    
  # subset T1 only
    df.mort.T1<-subset(df.mort, time.point=="T1")
    
    # by time * dom * light.level <- model failed to converge
        mod <- glmer(mortality ~  dom *light.level + (1|genotype) +(1|tank) , family=poisson(), data = df.mort.T1)
             Anova(mod)

  # subset T2 only
    df.mort.T2<-subset(df.mort, time.point=="T2")
    hist(df.mort.T2$mortality)
    
    # by time * dom * light.level <- model failed to converge
        mod <- glmer(mortality ~  dom * light.level + (1|genotype) +(1|tank) , family=poisson(), data = df.mort.T2)
             Anova(mod)   
# 
# df.mort %>%
#   filter(time.point == "T2") %>%
#   ggplot(aes(x = mortality)) +
#   geom_histogram(aes(y = ..density..)) +
#   facet_wrap(~dom)
             
# try again with mortality as a factor 
             
             
             
             
# try again ordinal factor, mordered logistic regression model, https://stats.oarc.ucla.edu/r/dae/ordinal-logistic-regression/
require(foreign)
require(ggplot2)
require(MASS)
require(Hmisc)
require(reshape2)
             
df.mort$mortatlity.f<-as.factor(as.character(df.mort$mortality))
# ordering the levels
df.mort$mortatlity.f <- ordered(df.mort$mortatlity.f, levels = c("1", "2","3","4","5","6"))         
     is.ordered(df.mort$mortatlity.f) #check
     
# model for ordered factor: polr()    
mod <- polr(mortatlity.f ~ dom + light.level + time.point, data = df.mort, Hess=TRUE)
summary(mod)
(ctable <- coef(summary(mod)))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))


mod <- lmer(mortatlity.f ~ time.point * dom *light.level + (1|genotype) +(1|tank) ,  data = df.mort)
    Anova(mod)

```

# Growth
```{r}
# Plot buoyant weight data for each frag
ggplot(df, aes(x = days, y = Dry.Weigh.g, color = dom, group = frag.id)) +
  facet_wrap(~light.level) + 
  geom_line()
# There are clearly some outlier values of weight to double check....checked them and only one was off.updated 2.1.22 SM

# Calculate growth rates
gr <- df %>%
  pivot_wider(id_cols = c(frag.id, time.point, genotype, light.level, tank, dom, color),
              names_from = time.point,
              values_from = Dry.Weigh.g) %>%
  # Calculate percent change per day during each time interval
  mutate(grT1 = (T1 - T0)/T0/30 * 100,
         grT2 = (T2 - T1)/T1/30 * 100) %>%
  dplyr::select(-T0, -T1, -T2, T1 = grT1, T2 = grT2) %>%
  pivot_longer(cols = c(T1, T2), names_to = "time.point", values_to = "growth.rate")

# Plot growth rates by predictors
ggplot(gr, aes(x = light.level, y = growth.rate)) +
  geom_boxplot() +
  facet_grid(time.point ~ dom)

# Fit model to find outliers based on growth rate residuals
grmod <- lmer(growth.rate ~ dom * light.level * time.point + (1|genotype) + (1|frag.id), data = gr)
grres <- augment(grmod)
ggplot(grres, aes(x = .resid)) + geom_histogram(bins = 50)

# Identify cutoffs using 1.5 * IQR
Q <- quantile(grres$.resid, probs=c(.25, .75), na.rm = TRUE)
iqr <- IQR(grres$.resid, na.rm = TRUE)
iqrbounds <- c(Q[1]-1.5*iqr, Q[2]+1.5*iqr)

# Identify cutoffs using 2 sd's
sdbounds <- c(mean(grres$.resid) - 2 * sd(grres$.resid),
              mean(grres$.resid) + 2 * sd(grres$.resid))

# Plot residuals with candidate cutoffs
ggplot(grres, aes(x = .resid)) + geom_histogram(bins = 50) +
  geom_vline(xintercept = iqrbounds, color = "red") +
  geom_vline(xintercept = sdbounds)

# Filter datasets based on these cutoffs
grres.f1 <- grres %>% filter(.resid > iqrbounds[1], .resid < iqrbounds[2])
nrow(grres) - nrow(grres.f1)
grres.f2 <- grres %>% filter(.resid > sdbounds[1], .resid < sdbounds[2])
nrow(grres) - nrow(grres.f2)

# Plot FILTERED growth rates by predictors
ggplot(grres.f1, aes(x = light.level, y = growth.rate)) +
  geom_boxplot() +
  facet_grid(time.point ~ dom) +
  ylim(-0.1, 0.5)

ggplot(grres.f2, aes(x = light.level, y = growth.rate)) +
  geom_violin() +
  facet_grid(time.point ~ dom) +
  ylim(-0.1, 0.5)

# Refit model with filtered dataset
mod <- lmer(growth.rate ~ dom * light.level * time.point + (1|genotype) + (1|frag.id), data = grres.f1)
Anova(mod)

hist(residuals(mod))
shapiro.test(residuals(mod))
qqPlot(residuals(mod))

emm <- emmeans(mod, ~ dom*light.level, adjust = "Tukey")

data.frame(emm) %>%
  ggplot(aes(x = light.level, y = emmean, color = dom)) +
  geom_point(position = position_dodge(width  = 0.5)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                position = position_dodge(width  = 0.5))


# Plot growth rate filtering by mortality
gr %>%
  ggplot(aes(x = light.level, y = growth.rate)) +
  geom_boxplot() +
  facet_grid(time.point ~ dom) +
  ylim(-0.1, 0.5)

gr %>% 
  left_join(df) %>%
  filter(mortality <= 2) %>%
  ggplot(aes(x = light.level, y = growth.rate)) +
  geom_boxplot() +
  facet_grid(time.point ~ dom) +
  ylim(-0.1, 0.5)
```

