---
title: "analysis.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(lme4)
library(emmeans)
library(multcomp)
library(broom.mixed)


library("car") #levenes test
library("ggplot2") #plotting
library("plotrix") #plotting
require("gridExtra") #Arrange Plots for output
require("utils")
library(lubridate)
library(lmerTest)
library(RColorBrewer)
library(colorRamps)

library(tidyverse)
```

# Load in data
```{r}
df <- read_csv("all_data_cleaned.csv") %>% 
  mutate(depth.m = as.numeric(depth.m),
         across(.cols = c(time.point, genotype, tank, dom, mix,
                          color, frag.id, tank, big.tank, light.level), as.factor)) %>%
  mutate(light.level = factor(light.level, levels = c("Natural", "Low Shade", "Medium Shade", "High Shade")))

```

# Mortality
```{r}
  ggplot(df.mort, aes(x = days, y = mortality, color = dom, group = frag.id)) +  # look at mort/time
   facet_wrap(~light.level) + 
    geom_line()

df.mort %>%
  pivot_wider(id_cols = c(frag.id, time.point, genotype, light.level, dom, color),
              names_from = time.point,
              values_from = mortality) %>%
  filter(T2 < T1)

# boxplot C v D:facet by shade treatment #####


df.mort %>%
  group_by(dom, light.level, time.point) %>%
  summarize(mean = mean(mortality, na.rm = T)) %>%
  ggplot(aes(x = ))

ggplot(df.mort, aes(x = time.point, y = mortality, color = dom)) +
  facet_wrap(~light.level) + 
   theme_classic()+
    geom_boxplot()

ggplot(df.mort, aes(x = interaction(dom,time.point), y = mortality, color = dom)) +
  facet_wrap(~light.level) + 
   theme_classic()+
    geom_jitter()+
    scale_y_continuous(breaks=1:6)
  


# models ####
# lmer <- probably should not use due to normality violations (all significant but time*dom*light interaction) ####
  
mod<-lmer(mortality ~ time.point * dom * light.level + (1|frag.id) + (1|genotype) + (1|tank), data = df.mort)
anova(mod)

hist(residuals(mod)) #normal
shapiro.test(residuals(mod))  #p-value < 2.2e-16
qqPlot(residuals(mod)) #kinda look like crap


#transform data, but it looks like crap still...not sure what else to do but make a factor
mod<-lmer(log10(mortality) ~ time.point * dom * light.level + (1|frag.id) + (1|genotype) + (1|tank), data = df.mort)
anova(mod)
  hist(residuals(mod)) #normal
  shapiro.test(residuals(mod))  #p-value < 2.2e-16
  qqPlot(residuals(mod)) #kinda look like crap
  
mod<-lmer((mortality^(1/3)) ~ time.point * dom * light.level + (1|frag.id) + (1|genotype) + (1|tank), data = df.mort)
anova(mod)
  hist(residuals(mod)) #normal
  shapiro.test(residuals(mod))  #p-value < 2.2e-16
  qqPlot(residuals(mod)) #kinda look like crap  

# T1 only
    df.mort.T1<-subset(df.mort, time.point=="T1")

    mod<-lmer(mortality ~  dom * light.level + (1|genotype) + (1|tank), data = df.mort.T1)
    anova(mod) # interaction not sig)
  
    hist(residuals(mod)) #normal
    shapiro.test(residuals(mod))  #p-value 4.698e-16
    qqPlot(residuals(mod)) #kinda look like crap
    
# T2 only
    df.mort.T2<-subset(df.mort, time.point=="T2")

    mod<-lmer(mortality ~  dom * light.level + (1|genotype) + (1|tank), data = df.mort.T2)
    anova(mod) # INTERACTION SIGNIFICANT**
  
    hist(residuals(mod)) #normal
    shapiro.test(residuals(mod))  #p-value 2.019e-12
    qqPlot(residuals(mod)) #kinda look like crap
             
        
##### GLMER tests  with mort as numeric ####
# glmer - full model (dom, light, time all significant, no interactions)
  mod <- glmer(mortality ~ dom * light.level *time.point + (1|frag.id) + (1|genotype) + (1|tank), family=poisson(), data = df.mort)
    Anova(mod)

  # by time only (significant)
  mod <- glmer(mortality ~ time.point +  (1|genotype) +(1|tank) , family=poisson(), data = df.mort)
    Anova(mod)
    
  # by time * dom (time, dom are sig, not interaction)
  mod <- glmer(mortality ~ time.point * dom + (1|genotype) +(1|tank) , family=poisson(), data = df.mort)
    Anova(mod)
    
# subset T1 only
    df.mort.T1<-subset(df.mort, time.point=="T1")
    
    # dom * light.level 
        # glmer <- singularities (dom is sig)
        mod <- glmer(mortality ~  dom *light.level + (1|genotype) +(1|tank), family=poisson(), data = df.mort.T1)
             Anova(mod)
        # lmer T1 only (dom and light sig, not interaction)
        mod <- lmer(mortality ~  dom *light.level + (1|genotype) +(1|tank), data = df.mort.T1)
             Anova(mod)

# subset T2 only
    df.mort.T2<-subset(df.mort, time.point=="T2")

    # dom * light.level <- model failed to converge
      
      #glmer singularities (dom and light sig, not interaction)
        mod <- glmer(mortality ~  dom * light.level + (1|genotype) +(1|tank) , family=poisson(), data = df.mort.T2)
             Anova(mod)  
             
########  try again with mortality as a factor  ###
df.mort$mortatlity.f<-as.factor(as.character(df.mort$mortality))

# ordering the levels
  df.mort$mortatlity.f <- ordered(df.mort$mortatlity.f, levels = c("1", "2","3","4","5","6"))         
     is.ordered(df.mort$mortatlity.f) #check
               

    
# try again ordinal factor, ordered logistic regression model, https://stats.oarc.ucla.edu/r/dae/ordinal-logistic-regression/
require(foreign)
require(ggplot2)
require(MASS)
require(Hmisc)
require(reshape2)
             

# model for ordered factor: polr()    
mod <- polr(mortatlity.f ~ dom + light.level + time.point, data = df.mort, Hess=TRUE)
summary(mod)
(ctable <- coef(summary(mod)))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))




# Lastly, changing mort scores into perent. 1=.2, 2=.15, 2=.38, 3=.63, 4=.875, 5=99.5
```


# Growth
```{r}
# Plot buoyant weight data for each frag
ggplot(df, aes(x = days, y = Dry.Weigh.g, color = dom, group = frag.id)) +
  facet_wrap(~light.level) + 
  geom_line()
# There are clearly some outlier values of weight to double check....checked them and only one was off.updated 2.1.22 SM

# Calculate growth rates
gr <- df %>%
  pivot_wider(id_cols = c(frag.id, time.point, genotype, light.level, tank, dom, color),
              names_from = time.point,
              values_from = Dry.Weigh.g) %>%
  # Calculate percent change per day during each time interval
  mutate(grT1 = (T1 - T0)/T0/30 * 100,
         grT2 = (T2 - T1)/T1/30 * 100) %>%
  dplyr::select(-T0, -T1, -T2, T1 = grT1, T2 = grT2) %>%
  pivot_longer(cols = c(T1, T2), names_to = "time.point", values_to = "growth.rate")

##############################################

# Plot growth rates by predictors
ggplot(gr, aes(x = light.level, y = growth.rate)) +
  geom_boxplot() +
  facet_grid(time.point ~ dom)

# Fit model to find outliers based on growth rate residuals
grmod <- lmer(growth.rate ~ dom * light.level * time.point + (1|genotype) + (1|frag.id) + (1|tank), data = gr)
grres <- augment(grmod)
ggplot(grres, aes(x = .resid, fill = .cooksd > 0.1)) + geom_histogram(bins = 50)

# Filter out observations with cooks distance > 0.1
grres.f <- grres %>% filter(.cooksd < 0.1)
nrow(grres) - nrow(grres.f)   # Filtered out 6 observations

# Plot FILTERED growth rates by predictors
ggplot(grres.f, aes(x = light.level, y = growth.rate)) +
  geom_boxplot() +
  geom_jitter() +
  facet_grid(time.point ~ dom)

# Refit model with filtered dataset
mod <- lmer(growth.rate ~ dom * light.level * time.point + (1|genotype) + (1|frag.id) + (1|tank), data = grres.f)
Anova(mod)

emm <- emmeans(mod, ~ dom*light.level)
rbind(contrast(emm, method = "pairwise", by = "light.level"), adjust = "fdr")

data.frame(emm) %>%
  ggplot(aes(x = light.level, y = emmean, color = dom)) +
  geom_point(position = position_dodge(width  = 0.5)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                position = position_dodge(width  = 0.5))
cld(emm)

##############################################

# FILTER dataset even more by mortality scores
# Plot growth rate filtering by mortality

grres.f %>% 
  left_join(df) %>%
  ggplot(aes(x = light.level, y = growth.rate)) +
  geom_boxplot() +
  geom_jitter(aes(color = mortality <= 1), alpha = 0.7) +
  facet_grid(time.point ~ dom) +
  ylim(-0.1, 0.5)


# Run stats on MORTALITY-FILTERED dataset
grres.ff <- grres.f %>%
  left_join(df) %>%
  filter(mortality <= 1 & !is.na(mortality))
  
mod <- lmer(growth.rate ~ dom * light.level * time.point + (1|genotype) + (1|frag.id) + (1|tank), data = grres.ff)
Anova(mod)
# symbiont x light.level interaction goes away when corals with high partial mortality are excluded. This is primarily driven by two D fragments under Natural light with mortality levels >2 that, when included, bring down the D/Natural growth rate enough to make it significantly less than the C/Natural growth rate. When these two fragments are excluded, the difference between C and D under natural light, and therefore the symbiont x light interaction in the model, disappear...

emm <- emmeans(mod, ~ dom*light.level|time.point)
cld(emm)
# No C-D difference when all treatments compared pairwise
rbind(contrast(emm, method = "pairwise", by = "light.level"), adjust = "fdr")
# marginally significant C-D difference at Natural light when only 4 tests conducted...

data.frame(emm) %>%
  ggplot(aes(x = light.level, y = emmean, color = dom)) +
  facet_wrap(~time.point) +
  geom_point(position = position_dodge(width  = 0.5)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                position = position_dodge(width  = 0.5))

```

```{r}
# separate brown C and orange C
mod <- lmer(growth.rate ~ color*dom * light.level * time.point + (1|genotype) + (1|frag.id) + (1|tank), 
            data = left_join(grres.ff, df))
Anova(mod)

emm <- emmeans(mod, ~ color:dom*light.level|time.point)

data.frame(emm) %>%
  ggplot(aes(x = light.level, y = emmean, color = interaction(color, dom))) +
  facet_wrap(~time.point) +
  geom_point(position = position_dodge(width  = 0.5)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                position = position_dodge(width  = 0.5))
```



```{r}
# What about modeling raw weight data over time?

mod <- lmer(Dry.Weigh.g ~ days * light.level * dom + (1|frag.id) + (1|genotype) + (1|tank), data = df)
moddf <- augment(mod)
moddf <- filter(moddf, .cooksd < 1)
mod <- lmer(Dry.Weigh.g ~ days * light.level * dom + (1|frag.id) + (1|genotype) + (1|tank), data = moddf)
Anova(mod)
hist(resid(mod))
emm <- emtrends(mod, ~ dom*light.level, var = "days")
cld(emm)
data.frame(emm) %>%
  ggplot(aes(x = light.level, y = days.trend, color = dom)) +
  geom_point(position = position_dodge(width  = 0.5)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                position = position_dodge(width  = 0.5))
```

